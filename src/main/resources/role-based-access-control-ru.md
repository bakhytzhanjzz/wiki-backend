# Система Ролей и Контроля Доступа Wiki

## Обзор

Система Wiki использует трехуровневую систему ролей для управления доступом пользователей к различным функциям платформы. Каждая роль имеет четко определенные права и ограничения, обеспечивающие безопасность данных и правильное функционирование бизнес-процессов.

---

## Три Роли Системы

### 1. ВЛАДЕЛЕЦ (OWNER)

**Описание:** Владелец компании имеет полный и неограниченный доступ ко всем функциям системы. Это высший уровень привилегий в рамках одной компании (арендатора).

**Права доступа:**
- ✅ Полный доступ ко всем функциям системы
- ✅ Управление пользователями (создание, редактирование, удаление, изменение ролей)
- ✅ Управление настройками компании
- ✅ Управление товарами (создание, редактирование, удаление)
- ✅ Управление категориями (создание, редактирование, удаление)
- ✅ Обработка продаж и возвратов
- ✅ Управление складом (поступления, списания)
- ✅ Просмотр всех продаж и истории
- ✅ Полный доступ к аналитике и отчетам
- ✅ Просмотр всех данных компании

**Ограничения:**
- Нет ограничений в рамках своей компании
- Не может получить доступ к данным других компаний (изоляция по tenant_id)

**Типичные сценарии использования:**
- Регистрация компании и создание первого пользователя
- Настройка системы под нужды бизнеса
- Управление командой сотрудников
- Анализ бизнес-показателей и принятие стратегических решений
- Контроль всех операций в системе

---

### 2. АДМИНИСТРАТОР (ADMIN)

**Описание:** Администратор имеет расширенные права для управления повседневными операциями компании, но не может управлять пользователями или настройками системы.

**Права доступа:**
- ✅ Управление товарами (создание, редактирование, удаление)
- ✅ Управление категориями (создание, редактирование, удаление)
- ✅ Обработка продаж и возвратов
- ✅ Управление складом (поступления, списания)
- ✅ Просмотр всех продаж и истории
- ✅ Полный доступ к аналитике и отчетам
- ✅ Просмотр каталога товаров и остатков

**Ограничения:**
- ❌ Не может управлять пользователями (создавать, удалять, менять роли)
- ❌ Не может изменять настройки компании
- ❌ Не может просматривать список пользователей

**Типичные сценарии использования:**
- Ежедневное управление товарным каталогом
- Контроль складских операций
- Анализ продаж и выручки
- Помощь продавцам в работе с системой
- Мониторинг бизнес-процессов

**Взаимодействие с другими ролями:**
- Может видеть продажи, сделанные продавцами
- Может помогать продавцам с возвратами
- Работает под контролем владельца

---

### 3. ПРОДАВЕЦ (SELLER)

**Описание:** Продавец имеет минимальные права, необходимые для выполнения продаж через POS-терминал. Это роль для кассиров и продавцов-консультантов.

**Права доступа:**
- ✅ Создание продаж через POS-терминал
- ✅ Обработка возвратов
- ✅ Просмотр каталога товаров (только чтение)
- ✅ Просмотр остатков товаров на складе (только чтение)
- ✅ Поиск товаров по названию или артикулу

**Ограничения:**
- ❌ Не может создавать, редактировать или удалять товары
- ❌ Не может управлять категориями
- ❌ Не может управлять складом (поступления, списания)
- ❌ Не может просматривать историю продаж
- ❌ Не может просматривать аналитику и отчеты
- ❌ Не может управлять пользователями
- ❌ Не может изменять настройки

**Типичные сценарии использования:**
- Обслуживание клиентов на кассе
- Оформление продаж через POS-терминал
- Обработка возвратов товаров
- Поиск товаров для клиентов
- Проверка наличия товара на складе

**Взаимодействие с другими ролями:**
- Работает с товарами, созданными администратором или владельцем
- Все его продажи видны администратору и владельцу
- Может обрабатывать возвраты, но не может видеть общую статистику

---

## Иерархия Ролей

```
ВЛАДЕЛЕЦ (OWNER)
    │
    ├── Полный контроль
    ├── Управление пользователями
    └── Все функции ADMIN + SELLER

АДМИНИСТРАТОР (ADMIN)
    │
    ├── Управление товарами и складом
    ├── Аналитика и отчеты
    └── Все функции SELLER

ПРОДАВЕЦ (SELLER)
    │
    └── Только POS и просмотр товаров
```

---

## Детальное Распределение Прав по Модулям

### Модуль: Аутентификация
- **OWNER, ADMIN, SELLER:** Все могут регистрироваться, входить в систему, обновлять токены

### Модуль: Товары
- **Создание/Редактирование/Удаление:** OWNER, ADMIN
- **Просмотр/Поиск:** OWNER, ADMIN, SELLER

### Модуль: Категории
- **Создание/Редактирование/Удаление:** OWNER, ADMIN
- **Просмотр:** OWNER, ADMIN, SELLER (неявно, через товары)

### Модуль: Продажи (POS)
- **Создание продажи:** OWNER, ADMIN, SELLER
- **Обработка возврата:** OWNER, ADMIN, SELLER
- **Просмотр истории продаж:** OWNER, ADMIN
- **Просмотр деталей продажи:** OWNER, ADMIN

### Модуль: Склад
- **Поступления на склад:** OWNER, ADMIN
- **Списания со склада:** OWNER, ADMIN
- **Просмотр истории операций:** OWNER, ADMIN
- **Просмотр текущих остатков:** OWNER, ADMIN, SELLER

### Модуль: Аналитика
- **Все функции аналитики:** OWNER, ADMIN
- **SELLER:** Полный запрет доступа

### Модуль: Пользователи
- **Все функции управления пользователями:** Только OWNER
- **ADMIN, SELLER:** Полный запрет доступа

### Модуль: Настройки
- **Все функции настроек:** Только OWNER
- **ADMIN, SELLER:** Полный запрет доступа

---

## Техническая Реализация

### Механизм Контроля Доступа

Система использует Spring Security с аннотациями `@PreAuthorize` для контроля доступа на уровне методов контроллеров. Каждый запрос проверяется на наличие необходимой роли перед выполнением операции.

### Формат Ролей в Системе

Роли хранятся в базе данных как перечисление (enum) и автоматически преобразуются в Spring Security authorities с префиксом "ROLE_":
- `OWNER` → `ROLE_OWNER`
- `ADMIN` → `ROLE_ADMIN`
- `SELLER` → `ROLE_SELLER`

### Изоляция Данных

Важно понимать, что все роли работают в рамках одной компании (арендатора). Даже владелец не может получить доступ к данным другой компании благодаря механизму изоляции по `tenant_id`.

---

## Примеры Рабочих Сценариев

### Сценарий 1: Открытие нового магазина

1. **Владелец** регистрирует компанию в системе
2. **Владелец** создает товары и категории
3. **Владелец** создает учетные записи для администратора и продавцов
4. **Администратор** начинает ежедневное управление товарами
5. **Продавцы** начинают обслуживать клиентов через POS

### Сценарий 2: Ежедневная работа магазина

1. **Администратор** проверяет остатки и делает поступления на склад
2. **Продавцы** обслуживают клиентов и создают продажи
3. **Администратор** в конце дня просматривает аналитику продаж
4. **Владелец** периодически проверяет общую статистику и управляет командой

### Сценарий 3: Обработка возврата

1. Клиент возвращает товар
2. **Продавец** или **Администратор** обрабатывает возврат через систему
3. Остатки товара автоматически восстанавливаются
4. **Администратор** видит возврат в истории продаж

### Сценарий 4: Управление персоналом

1. **Владелец** создает нового сотрудника с ролью продавца
2. Новый сотрудник получает доступ только к POS-терминалу
3. При необходимости **Владелец** может повысить роль до администратора
4. **Владелец** может деактивировать или удалить учетную запись

---

## Безопасность и Рекомендации

### Рекомендации по Назначению Ролей

1. **Владелец:** Только реальный владелец бизнеса или доверенное лицо
2. **Администратор:** Менеджер магазина, старший продавец, бухгалтер
3. **Продавец:** Обычные кассиры и продавцы-консультанты

### Лучшие Практики

- Минимизируйте количество пользователей с ролью Владелец
- Регулярно проверяйте список пользователей и их роли
- Используйте роль Администратор для повседневного управления
- Назначайте роль Продавец всем сотрудникам, работающим на кассе

### Аудит и Отслеживание

Все действия пользователей логируются в системе с указанием:
- Кто выполнил действие (user_id)
- Когда было выполнено действие (timestamp)
- Что было изменено (детали операции)

Это позволяет отслеживать все изменения в системе и обеспечивает прозрачность операций.

---

## Заключение

Система ролей Wiki обеспечивает гибкое и безопасное управление доступом к функциям платформы. Каждая роль имеет четко определенные права, что позволяет эффективно распределять обязанности между сотрудниками и поддерживать контроль над бизнес-процессами.

Трехуровневая структура (Владелец → Администратор → Продавец) обеспечивает баланс между функциональностью и безопасностью, позволяя каждому сотруднику иметь доступ только к тем функциям, которые необходимы для выполнения его работы.

